name: SonarQube Analytics

on:
    push:
        branches:
            - develop
            - main

jobs:
    build:
        name: Build
        runs-on: arc-runners
        permissions: read-all
        steps:
            - uses: actions/checkout@v2
              with:
                  fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
            - name: Set up JDK 21
              uses: actions/setup-java@v1
              with:
                  java-version: 21
            - name: Cache SonarQube packages
              uses: actions/cache@v1
              with:
                  path: ~/.sonar/cache
                  key: ${{ runner.os }}-sonar
                  restore-keys: ${{ runner.os }}-sonar
            - name: Cache Gradle packages
              uses: actions/cache@v1
              with:
                  path: ~/.gradle/caches
                  key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle', '**/gradle-wrapper.properties') }}
                  restore-keys: ${{ runner.os }}-gradle
            - name: Build and analyze
              env:
                  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
                  SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
              run: ./gradlew build sonar --info

            - name: SonarQube Quality Gate Check
              uses: SonarSource/sonarqube-quality-gate-action@v1.1.0
              with:
                  scanMetadataReportFile: build/sonar/report-task.txt
              env:
                  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
                  SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

