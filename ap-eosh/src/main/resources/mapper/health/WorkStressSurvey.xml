<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.airpremia.eosh.personaldetail.health.repository.WorkStressSurveyRepository">

    <select id="selectUserWorkStressSurveyPage" resultType="UserWorkStressSurveyPageResponse">
        SELECT
             usr.user_seq
            ,usr.user_id
            ,usr.user_job_classification_classification_enum
            ,usr.sex
            ,usr.dept_cd
            ,uwss.standard_yyyy
            ,uwss.average_score
            ,uwss.survey_status
        FROM user usr
        LEFT JOIN user_work_stress_survey uwss
            ON usr.user_seq = uwss.user_seq
        <where>
           AND uwss.survey_status IS NOT NULL
           <if test="@com.airpremia.esmsfos.core.MybatisUtils@isNotEmpty(searchDto.deptCd)">
                AND usr.dept_cd = #{searchDto.deptCd}
           </if>
           <if test="@com.airpremia.esmsfos.core.MybatisUtils@isNotEmpty(searchDto.userJobClassificationClassificationEnum)">
                AND usr.user_job_classification_classification_enum = #{searchDto.userJobClassificationClassificationEnum}
           </if>
           <if test="@com.airpremia.esmsfos.core.MybatisUtils@isNotEmpty(searchDto.standardYyyy)">
                AND uwss.standard_yyyy = #{searchDto.standardYyyy}
           </if>
           <if test="@com.airpremia.esmsfos.core.MybatisUtils@isNotEmpty(searchDto.surveyStatus)">
                AND uwss.survey_status = #{searchDto.surveyStatus}
           </if>
           <if test="@com.airpremia.esmsfos.core.MybatisUtils@isNotEmpty(searchDto.userId)">
                AND uwss.insert_user_id = #{searchDto.userId}
           </if>
           <if test="@com.airpremia.esmsfos.core.MybatisUtils@isNotEmpty(searchDto.sex)">
                AND usr.sex = #{searchDto.sex}
           </if>
        </where>
    </select>
    <select id="selectUserWorkStressSurvey" resultType="UserWorkStressSurveyDto">
        SELECT
            uwssa.user_work_stress_survey_answer_seq
            ,uwssa.user_seq
            ,uwssa.standard_yyyy
            ,uwssa.evaluation_item_code
            ,uwssa.question_code
            ,uwssa.score
            ,usr.sex
        FROM user_work_stress_survey_answer uwssa
        LEFT JOIN user usr
        ON uwssa.user_seq = usr.user_seq
        WHERE uwssa.user_seq = #{userSeq}
          AND uwssa.standard_yyyy = #{standardYyyy}
    </select>
    <select id="checkUserWorkStressSurveyAnswerList" resultType="UserWorkStressSurveyAnswerDto">
        SELECT
            user_seq
            ,standard_yyyy
            ,evaluation_item_code
            ,question_code
        FROM user_work_stress_survey_answer
        WHERE user_seq = #{userSeq}
          AND standard_yyyy = #{standardYyyy}
    </select>
    <insert id="insertUserWorkStressSurvey">
        INSERT INTO user_work_stress_survey (
            user_seq
            ,standard_yyyy
            ,average_score
            ,survey_status
            ,insert_user_id
            ,insert_ip
        )VALUES(
             #{userSeq}
            ,#{standardYyyy}
            ,#{averageScore}
            ,#{surveyStatus}
            ,#{insertUserId}
            ,#{insertIp}
        )
    </insert>
    <update id="updateUserWorkStressSurvey">
        UPDATE user_work_stress_survey
        SET
             average_score = #{averageScore}
            ,survey_status = #{surveyStatus}
            ,update_user_id = #{updateUserId}
            ,update_dtm = #{updateDtm}
        WHERE user_seq = #{userSeq}
          AND standard_yyyy = #{standardYyyy}
    </update>
    <select id="checkUserWorkStressSurveyAnswerSave" resultType="int">
        SELECT COUNT(1)
        FROM user_work_stress_survey_answer
        WHERE
            user_seq = #{userSeq}
        AND standard_yyyy = #{standardYyyy}
        AND evaluation_item_code = #{evaluationItemCode}
        AND question_code = #{questionCode}
    </select>
    <insert id="insertUserWorkStressSurveyAnswer">
        INSERT INTO user_work_stress_survey_answer(
             user_seq
            ,standard_yyyy
            ,evaluation_item_code
            ,question_code
            ,score
            ,insert_user_id
            ,insert_ip
        )VALUES(
             #{userSeq}
            ,#{standardYyyy}
            ,#{evaluationItemCode}
            ,#{questionCode}
            ,#{score}
            ,#{insertUserId}
            ,#{insertIp}
        )
    </insert>
    <update id="updateUserWorkStressSurveyAnswer">
        UPDATE user_work_stress_survey_answer
        SET
            score = #{score}
          ,update_user_id = #{updateUserId}
          ,update_dtm = #{updateDtm}
        WHERE
            user_seq = #{userSeq}
        AND standard_yyyy = #{standardYyyy}
        AND evaluation_item_code = #{evaluationItemCode}
        AND question_code = #{questionCode}
    </update>
    <update id="updateUserSex">
        UPDATE `user`
        SET sex = #{sex}
        WHERE user_seq = #{userSeq}
    </update>
    <select id="selectUserStressSurveyResult" resultType="WorkStressSurveyReportDto">
        SELECT
            uwssa.standard_yyyy
            ,uwssa.evaluation_item_code
            ,SUM(uwssa.score) AS score
        FROM user_work_stress_survey_answer uwssa
        JOIN user usr ON uwssa.user_seq = usr.user_seq
        <where>
            AND uwssa.standard_yyyy = #{standardYyyy}
        <if test="@com.airpremia.esmsfos.core.MybatisUtils@isNotEmpty(userSeq)">
            AND usr.user_seq = #{userSeq}
        </if>
        <if test="@com.airpremia.esmsfos.core.MybatisUtils@isNotEmpty(sex)">
            AND usr.sex = #{sex}
        </if>
        <if test="@com.airpremia.esmsfos.core.MybatisUtils@isNotEmpty(deptCd)">
            AND usr.dept_cd = #{deptCd}
        </if>
        </where>
        GROUP BY evaluation_item_code
    </select>

    <select id="selectWorkStressSurveyUserSeq" resultType="long">
        SELECT
            user_seq
        FROM user
        <where>
            AND user_id = #{userId}
        </where>
    </select>

    <select id="selectWorkStressSurveyScore" resultType="HealthPageDto">
        SELECT
            score
        FROM user_work_stress_survey_answer
        WHERE user_seq = #{userSeq}
          AND standard_yyyy = #{standardYyyy}
    </select>

    <select id="selectSurveySubmittedUsers" resultType="WorkStressSurveySubmittedUsersDto">
        SELECT
            user_seq
            ,standard_yyyy
            ,average_score
            ,survey_status
        FROM user_work_stress_survey
        WHERE survey_status = 'SUBMIT'
          AND standard_yyyy = #{standardYyyy}
    </select>

    <select id="selectSurveySubmittedDeptUsers" resultType="WorkStressSurveySubmittedUsersDto">
        SELECT
            uwssa.user_seq
            ,uwssa.standard_yyyy
            ,uwssa.average_score
            ,uwssa.survey_status
        FROM user_work_stress_survey uwssa
        LEFT JOIN user usr
        ON uwssa.user_seq = usr.user_seq
        WHERE uwssa.survey_status = 'SUBMIT'
        AND uwssa.standard_yyyy = #{standardYyyy}
        AND usr.dept_cd = #{deptCd}
    </select>

    <select id="checkSurveyStatus" resultType="SurveyStatusEnum">
        SELECT
            survey_status
        FROM user_work_stress_survey
        WHERE user_seq = #{userSeq}
          AND standard_yyyy = #{standardYyyy}
    </select>
</mapper>
