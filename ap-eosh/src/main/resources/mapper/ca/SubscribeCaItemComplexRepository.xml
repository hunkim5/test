<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.airpremia.eosh.ca.repository.SubscribeCaItemComplexRepository">
    <sql id="ca-item-collection">
        SELECT
        DISTINCT t_mast.subscribe_ca_item_seq
        ,t_mast.subscribe_ca_uuid
        ,t_mast.ca_id
        ,t_mast.ca_appvalprc_enum
        ,t_mast.incharge_user_id
        ,t_mast.incharge_user_name
        ,t_mast.incharge_department_id
        ,t_mast.incharge_department_name
        ,t_mast.ca_subject
        ,t_mast.ca_content
        ,t_mast.ca_deadline_dt
        ,t_mast.cap_content
        ,t_mast.cap_multiple_file_uuid
        ,t_mast.cap_expect_complete_dt
        ,t_mast.cai_content
        ,t_mast.cai_complete_dt
        ,t_mast.cai_multiple_file_uuid
        ,t_mast.cap_root_cause_content
        ,t_mast.feedback_content
        ,t_mast.insert_user_id
        ,t_mast.insert_dtm
        ,t_mast.insert_ip
        ,t_mast.update_user_id
        ,t_mast.update_dtm
        ,t_mast.update_ip
        ,t_issue.issue_id
        ,t_issue.issue_target_enum
        ,t_issue.report_uuid
        ,t_issue.source_id AS issue_source_id
        FROM
        subscribe_ca_item t_mast
        inner join subscribe_ca t_ca
        on
        (
            t_ca.subscribe_ca_uuid = t_mast.subscribe_ca_uuid
        )
            left outer join issue t_issue
        on
        (
            t_issue.subscribe_ca_uuid = t_ca.subscribe_ca_uuid
        )
            left outer join subscribe_ca_item_incharge t_scii
        on
        (
            t_scii.subscribe_ca_item_seq = t_mast.subscribe_ca_item_seq
        )
    </sql>
    <sql id="ca-collection-param">
        <where>
            and t_mast.delete_bool = false
            and t_mast.ca_appvalprc_enum <![CDATA[<>]]> 'DRAFT'
            <if test="@com.airpremia.esmsfos.core.MybatisUtils@isNotEmpty(searchDto.inchargeUserId)">
                and t_mast.incharge_user_id = #{searchDto.inchargeUserId}
            </if>
            <if test="@com.airpremia.esmsfos.core.MybatisUtils@isNotEmpty(searchDto.inchargeDepartmentId)">
                and t_mast.incharge_department_id = #{searchDto.inchargeDepartmentId}
            </if>
            <if test="@com.airpremia.esmsfos.core.MybatisUtils@isNotEmpty(searchDto.caSubject)">
                and t_mast.ca_subject like #{searchDto.caSubject}
            </if>
            <if test="@com.airpremia.esmsfos.core.MybatisUtils@isNotEmpty(searchDto.caAppvalprcEnum)">
                and t_mast.ca_appvalprc_enum like #{searchDto.caAppvalprcEnum}
            </if>
            <if test="@com.airpremia.esmsfos.core.MybatisUtils@isNotEmpty(searchDto.startInsertDtm)">
                and t_mast.insert_dtm <![CDATA[>=]]> #{searchDto.startInsertDtm}
            </if>
            <if test="@com.airpremia.esmsfos.core.MybatisUtils@isNotEmpty(searchDto.endInsertDtm)">
                and t_mast.insert_dtm <![CDATA[<=]]> #{searchDto.endInsertDtm}
            </if>
            <if test="@com.airpremia.esmsfos.core.MybatisUtils@isNotEmpty(searchDto.startCapExpectCompleteDt)">
                and t_mast.cap_expect_complete_dt <![CDATA[>=]]> #{searchDto.startCapExpectCompleteDt}
            </if>
            <if test="@com.airpremia.esmsfos.core.MybatisUtils@isNotEmpty(searchDto.endCapExpectCompleteDt)">
                and t_mast.cap_expect_complete_dt <![CDATA[<=]]> #{searchDto.endCapExpectCompleteDt}
            </if>
             <if test="@com.airpremia.esmsfos.core.MybatisUtils@isNotEmpty(searchDto.startCaiCompleteDt)">
                and t_mast.cai_complete_dt <![CDATA[>=]]> #{searchDto.startCaiCompleteDt}
            </if>
            <if test="@com.airpremia.esmsfos.core.MybatisUtils@isNotEmpty(searchDto.endCaiCompleteDt)">
                and t_mast.cai_complete_dt <![CDATA[<=]]> #{searchDto.endCaiCompleteDt}
            </if>
        </where>
    </sql>

    <select id="selectPage" resultType="SubscribeCaItemWithSourceDto">
        <include refid="ca-item-collection" />
        <include refid="ca-collection-param" />
        and t_scii.incharge_user_id = #{searchDto.assignedUserId}
        order by
        t_mast.subscribe_ca_item_seq desc
    </select>

    <select id="selectList" resultType="SubscribeCaItemWithSourceDto">
        <include refid="ca-item-collection" />
        <include refid="ca-collection-param" />
        and t_scii.incharge_user_id = #{searchDto.assignedUserId}
        order by
        t_mast.subscribe_ca_item_seq desc
    </select>

    <select id="selectAdminPage" resultType="SubscribeCaItemWithSourceDto">
        <include refid="ca-item-collection" />
        <include refid="ca-collection-param" />
        <if test="@com.airpremia.esmsfos.core.MybatisUtils@isNotEmpty(searchDto.accessibleDepartmentCdList)">
            AND t_scii.incharge_department_id IN (
                <foreach collection="searchDto.accessibleDepartmentCdList" item="item" separator=", ">
                    #{item}
                </foreach>
            )
        </if>
        order by
        t_mast.subscribe_ca_item_seq desc
    </select>

    <select id="selectAdminList" resultType="SubscribeCaItemWithSourceDto">
        <include refid="ca-item-collection" />
        <include refid="ca-collection-param" />
        <if test="@com.airpremia.esmsfos.core.MybatisUtils@isNotEmpty(searchDto.accessibleDepartmentCdList)">
            AND t_scii.incharge_department_id IN (
                <foreach collection="searchDto.accessibleDepartmentCdList" item="item" separator=", ">
                    #{item}
                </foreach>
            )
        </if>
        order by
        t_mast.subscribe_ca_item_seq desc
    </select>
</mapper>
