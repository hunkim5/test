<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.airpremia.eosh.report.workreport.safeguarding.repository.WorkReportSafeguardingRepository">
    <select id="selectWorkReportSafeguardingPage" resultType="WorkReportSafeguardingDto">
            SELECT safeguarding_seq
            ,request_department
            ,storage_department_code
            ,job_division_code
            ,safety_certification_bool
            ,autonomy_safety_check_report_bool
            ,safety_inspection_bool
            ,etc_bool
            ,movement_area_registration_no
            ,new_division_code
            ,safeguarding_code
            ,protect_gear_code
            ,product_manufacturer_name
            ,product_manufacturer_phoneno
            ,product_manufacturer_email
            ,product_name
            ,product_model_name
            ,add_description
            ,multiple_file_safetycertification_uuid
            ,multiple_file_safetyinspection_uuid
            ,multiple_file_autonomysafety_uuid
            ,protection_device_quantity
            ,protect_gear_quantity
            ,request_department_name
            ,request_user_id
            ,report_no
            ,approval_work_report_status_enum
            ,protect_gear_detail_code
            ,registration_dt
            ,expiration_dt
            ,manufacturing_dt
            ,disposal_dt
            ,replacement_recommend_condition
            ,reject_reason
            ,subject
            ,request_user_name
            ,insert_dtm
    FROM work_report_safeguarding
    <where>
        <if test="@com.airpremia.esmsfos.core.MybatisUtils@isNotEmpty(searchDto.reportNo)">
            AND report_no LIKE #{searchDto.reportNo}
        </if>
        <if test="@com.airpremia.esmsfos.core.MybatisUtils@isNotEmpty(searchDto.requestDepartment)">
            AND request_department = #{searchDto.requestDepartment}
        </if>
        <if test="@com.airpremia.esmsfos.core.MybatisUtils@isNotEmpty(searchDto.requestUserId)">
            AND request_user_id = #{searchDto.requestUserId}
        </if>
        <if test="@com.airpremia.esmsfos.core.MybatisUtils@isNotEmpty(searchDto.jobDivisionCode)">
            AND job_division_code = #{searchDto.jobDivisionCode}
        </if>
        <if test="@com.airpremia.esmsfos.core.MybatisUtils@isNotEmpty(searchDto.protectGearCode)">
            AND protect_gear_code = #{searchDto.protectGearCode}
        </if>
        <if test="@com.airpremia.esmsfos.core.MybatisUtils@isNotEmpty(searchDto.safeguardingCode)">
            AND safeguarding_code = #{searchDto.safeguardingCode}
        </if>
        <if test="@com.airpremia.esmsfos.core.MybatisUtils@isNotEmpty(searchDto.approvalWorkReportStatusEnum)">
            AND approval_work_report_status_enum = #{searchDto.approvalWorkReportStatusEnum}
        </if>
    </where>
    ORDER BY safeguarding_seq DESC
    </select>

    <select id="selectWorkReportSafeguarding" resultType="WorkReportSafeguardingDto">
        SELECT safeguarding_seq
             ,request_department
             ,storage_department_code
             ,job_division_code
             ,safety_certification_bool
             ,autonomy_safety_check_report_bool
             ,safety_inspection_bool
             ,etc_bool
             ,movement_area_registration_no
             ,new_division_code
             ,safeguarding_code
             ,protect_gear_code
             ,product_manufacturer_name
             ,product_manufacturer_phoneno
             ,product_manufacturer_email
             ,product_name
             ,product_model_name
             ,add_description
             ,multiple_file_safetycertification_uuid
             ,multiple_file_safetyinspection_uuid
             ,multiple_file_autonomysafety_uuid
             ,protection_device_quantity
             ,protect_gear_quantity
             ,request_department_name
             ,request_user_id
             ,report_no
             ,approval_work_report_status_enum
             ,protect_gear_detail_code
             ,registration_dt
             ,expiration_dt
             ,manufacturing_dt
             ,disposal_dt
             ,replacement_recommend_condition
             ,reject_reason
             ,subject
             ,request_user_name
        FROM work_report_safeguarding
        WHERE
            safeguarding_seq = #{safeguardingSeq}
    </select>

    <insert id="insertWorkReportSafeguarding" useGeneratedKeys="true" keyProperty="safeguardingSeq">
        INSERT INTO work_report_safeguarding
        (request_department
        ,storage_department_code
        ,job_division_code
        ,safety_certification_bool
        ,autonomy_safety_check_report_bool
        ,safety_inspection_bool
        ,etc_bool
        ,movement_area_registration_no
        ,new_division_code
        ,safeguarding_code
        ,protect_gear_code
        ,product_manufacturer_name
        ,product_manufacturer_phoneno
        ,product_manufacturer_email
        ,product_name
        ,product_model_name
        ,add_description
        ,multiple_file_safetycertification_uuid
        ,multiple_file_safetyinspection_uuid
        ,multiple_file_autonomysafety_uuid
        ,protection_device_quantity
        ,protect_gear_quantity
        ,request_department_name
        ,request_user_id
        ,report_no
        ,approval_work_report_status_enum
        ,protect_gear_detail_code
        ,registration_dt
        ,expiration_dt
        ,manufacturing_dt
        ,disposal_dt
        ,replacement_recommend_condition
        ,reject_reason
        ,subject
        ,request_user_name
        ,insert_ip
        ,insert_user_id)
        VALUES
            (#{requestDepartment}
            ,#{storageDepartmentCode}
            ,#{jobDivisionCode}
            ,#{safetyCertificationBool}
            ,#{autonomySafetyCheckReportBool}
            ,#{safetyInspectionBool}
            ,#{etcBool}
            ,#{movementAreaRegistrationNo}
            ,#{newDivisionCode}
            ,#{safeguardingCode}
            ,#{protectGearCode}
            ,#{productManufacturerName}
            ,#{productManufacturerPhoneno}
            ,#{productManufacturerEmail}
            ,#{productName}
            ,#{productModelName}
            ,#{addDescription}
            ,#{multipleFileSafetycertificationUuid}
            ,#{multipleFileSafetyinspectionUuid}
            ,#{multipleFileAutonomysafetyUuid}
            ,#{protectionDeviceQuantity}
            ,#{protectGearQuantity}
            ,#{requestDepartmentName}
            ,#{requestUserId}
            ,#{reportNo}
            ,#{approvalWorkReportStatusEnum}
            ,#{protectGearDetailCode}
            ,#{registrationDt}
            ,#{expirationDt}
            ,#{manufacturingDt}
            ,#{disposalDt}
            ,#{replacementRecommendCondition}
            ,#{rejectReason}
            ,#{subject}
            ,#{requestUserName}
            ,#{insertIp}
            ,#{insertUserId})
    </insert>

    <update id="updateWorkReportSafeguarding">
        UPDATE work_report_safeguarding SET
        request_department = #{requestDepartment}
        ,storage_department_code = #{storageDepartmentCode}
        ,job_division_code = #{jobDivisionCode}
        ,safety_certification_bool = #{safetyCertificationBool}
        ,autonomy_safety_check_report_bool = #{autonomySafetyCheckReportBool}
        ,safety_inspection_bool = #{safetyInspectionBool}
        ,etc_bool = #{etcBool}
        ,movement_area_registration_no = #{movementAreaRegistrationNo}
        ,new_division_code = #{newDivisionCode}
        ,safeguarding_code = #{safeguardingCode}
        ,protect_gear_code = #{protectGearCode}
        ,product_manufacturer_name = #{productManufacturerName}
        ,product_manufacturer_phoneno = #{productManufacturerPhoneno}
        ,product_manufacturer_email = #{productManufacturerEmail}
        ,product_name = #{productName}
        ,product_model_name = #{productModelName}
        ,add_description = #{addDescription}
        ,multiple_file_safetycertification_uuid = #{multipleFileSafetycertificationUuid}
        ,multiple_file_safetyinspection_uuid = #{multipleFileSafetyinspectionUuid}
        ,multiple_file_autonomysafety_uuid = #{multipleFileAutonomysafetyUuid}
        ,protection_device_quantity = #{protectionDeviceQuantity}
        ,protect_gear_quantity = #{protectGearQuantity}
        ,request_department_name = #{requestDepartmentName}
        ,request_user_id = #{requestUserId}
        ,report_no = #{reportNo}
        ,approval_work_report_status_enum = #{approvalWorkReportStatusEnum}
        ,protect_gear_detail_code = #{protectGearDetailCode}
        ,registration_dt = #{registrationDt}
        ,expiration_dt = #{expirationDt}
        ,manufacturing_dt = #{manufacturingDt}
        ,disposal_dt = #{disposalDt}
        ,replacement_recommend_condition = #{replacementRecommendCondition}
        ,reject_reason = #{rejectReason}
        ,subject = #{subject}
        ,request_user_name = #{requestUserName}
        ,update_ip = #{updateIp}
        ,update_user_id = #{updateUserId}
        <where>
            safeguarding_seq = #{safeguardingSeq}
        </where>
    </update>

    <delete id="deleteWorkReportSafeguarding">
        DELETE
        FROM work_report_safeguarding
        <where>
            AND safeguarding_seq = #{safeguardingSeq}
        </where>
    </delete>

    <select id="selectDeptProtectGearCount" resultType="int">
        SELECT
            COUNT(dept_protect_gear_status_seq)
        FROM
            dept_protectgear_status
        <where>
            AND storage_department_code = #{storageDepartmentCode}
            AND protect_gear_code = #{protectGearCode}
        </where>
    </select>

    <update id="updateDeptProtectGearQuantity">
        UPDATE dept_protectgear_status SET
            quantity = quantity + #{protectGearQuantity}
            ,update_user_id = #{updateUserId}
            ,update_ip = #{updateIp}
        <where>
            AND storage_department_code = #{storageDepartmentCode}
            AND protect_gear_code = #{protectGearCode}
        </where>
    </update>

    <insert id="insertDeptProtectGearQuantity">
        INSERT INTO dept_protectgear_status(
            storage_department_code
            ,protect_gear_code
            ,protect_gear_detail_code
            ,quantity
            ,user_name
            ,department_name
            ,insert_user_id
            ,insert_ip
        ) VALUES (
            #{storageDepartmentCode}
            ,#{protectGearCode}
            ,#{protectGearDetailCode}
            ,#{protectGearQuantity}
            ,#{requestUserName}
            ,#{requestDepartmentName}
            ,#{insertUserId}
            ,#{insertIp}
        )
    </insert>

    <insert id="insertDeptSafeguardingQuantity">
        INSERT INTO dept_protectgear_status(
            storage_department_code
            ,safeguarding_code
            ,quantity
            ,user_name
            ,department_name
            ,insert_user_id
            ,insert_ip
        ) VALUES (
            #{storageDepartmentCode}
            ,#{safeguardingCode}
            ,#{protectionDeviceQuantity}
            ,#{requestUserName}
            ,#{requestDepartmentName}
            ,#{insertUserId}
            ,#{insertIp}
        )
    </insert>

    <update id="updateWorkReportSafeguardingStatus">
        UPDATE work_report_safeguarding SET
            approval_work_report_status_enum = #{approvalWorkReportStatusEnum}
            ,registration_dt = #{registrationDt}
            ,reject_reason = #{rejectReason}
        WHERE
            safeguarding_seq = #{safeguardingSeq}
    </update>

    <select id="selectSafeguardingDeptQuantity" resultType="WorkReportSafeguardingDeptQuantityDto">
        SELECT
            quantity
            ,safeguarding_code
            ,storage_department_code
        FROM dept_protectiondevice_status
        WHERE storage_department_code = #{storageDepartmentCode}
          ups.safeguarding_code IS NOT NULL
    </select>
    <select id="selectUserProtectiondevicePage" resultType="UserProtectiondeviceDto">
        SELECT
             user_protectiondevice_status_seq
            ,safeguarding_code
            ,quantity
            ,storage_department_code
            ,manufacturing_dt
            ,disposal_dt
            ,user_id
            ,signature_bool
        FROM user_protectiondevice_status
        WHERE user_id = #{searchDto.userId}
        <if test="@com.airpremia.esmsfos.core.MybatisUtils@isNotEmpty(SearchDto.safeguardingCode)">
            AND safeguarding_code = #{safeguardingCode}
        </if>
    </select>
    <select id="selectUserProtectGearPage" resultType="UserProtectGearDto">
        SELECT
              user_protect_gear_status_seq
             ,protect_gear_code
             ,protect_gear_detail_code
             ,quantity
             ,storage_department_code
             ,manufacturing_dt
             ,disposal_dt
             ,user_id
             ,signature_bool
        FROM user_protectgear_status
        WHERE user_id = #{searchDto.userId}
        <if test="@com.airpremia.esmsfos.core.MybatisUtils@isNotEmpty(SearchDto.protectGearCode)">
            AND protect_gear_code = #{protectGearCode}
        </if>
        <if test="@com.airpremia.esmsfos.core.MybatisUtils@isNotEmpty(SearchDto.protectGearDetailCode)">
            AND protect_gear_detail_code = #{protectGearDetailCode}
        </if>
    </select>

    <update id="updateUserProtectiondeviceQuantity">
        UPDATE user_protectiondevice_status SET
             quantity = #{quantity}
        FROM
        WHERE user_protectiondevice_status_seq = #{userProtectiondeviceStatusSeq}
    </update>
    <update id="updateUserProtectGearQuantity">
        UPDATE user_protectgear_status SET
             quantity = #{quantity}
        FROM
        WHERE user_protect_gear_status_seq = #{userProtectGearStatusSeq}
    </update>
    <update id="updateWorkReportSafeguardingSafeguardingQuantity">
        UPDATE work_report_safeguarding SET
             protection_device_quantity = #{protectionDeviceQuantity}
        FROM
        WHERE storage_department_code = #{storageDepartmentCode}
          AND safeguarding_code = #{safeguardingCode}
    </update>
    <update id="updateWorkReportSafeguardingProtectGearQuantity">
        UPDATE work_report_safeguarding SET
             protect_gear_quantity = #{protectGearQuantity}
        FROM
        WHERE storage_department_code = #{storageDepartmentCode}
          AND protect_gear_code = #{protectGearCode}
    </update>
    <select id="selectSafeguardingReportCount" resultType="String">
        SELECT
        report_no
        FROM work_report_safeguarding
        <where>
            AND report_no LIKE #{searchReportNumber}
        </where>
        ORDER BY report_no DESC
    </select>
</mapper>
